---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2auth{{ template "enterpriseSuffix" . }}
  labels:
    app: st2auth
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2auth
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2auth
  # Multiple st2auth processes can be behind a load balancer in an active-active configuration.
  replicas: {{ default 2 .Values.st2auth.replicas }}
  template:
    metadata:
      labels:
        app: st2auth
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
        checksum/auth: {{ include (print $.Template.BasePath "/secrets_st2auth.yaml") . | sha256sum }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      # Sidecar container for generating .htpasswd with st2 username & password pair and sharing produced file with the main st2auth container
      initContainers:
      - name: generate-htpasswd
        image: "{{ template "imageRepository" . }}/st2auth{{ template "enterpriseSuffix" . }}:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        env:
        - name: ST2_AUTH_USERNAME
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-st2-auth
              key: username
        - name: ST2_AUTH_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-st2-auth
              key: password
        volumeMounts:
        - name: htpasswd-vol
          mountPath: /tmp/st2
        command:
          - 'sh'
          - '-ec'
          - printf "${ST2_AUTH_USERNAME}:$(openssl passwd -apr1 "${ST2_AUTH_PASSWORD}")\n" > /tmp/st2/htpasswd
      containers:
      - name: st2auth{{ template "enterpriseSuffix" . }}
        image: "{{ template "imageRepository" . }}/st2auth{{ template "enterpriseSuffix" . }}:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - containerPort: 9100
        # TODO: Add liveness/readiness probes (#3)
        #livenessProbe:
        #readinessProbe:
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        - name: htpasswd-vol
          mountPath: /etc/st2/htpasswd
          subPath: htpasswd
          readOnly: true
        resources:
{{ toYaml .Values.st2auth.resources | indent 10 }}
    {{- if .Values.st2auth.serviceAccount.attach }}
      serviceAccountName: {{ template "stackstorm-ha.serviceAccountName" . }}
    {{- end }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
        - name: htpasswd-vol
          emptyDir:
            medium: Memory
    {{- with .Values.st2auth.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2auth.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2auth.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2api{{ template "enterpriseSuffix" . }}
  labels:
    app: st2api
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2api
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2api
  # Multiple st2api process can be behind a load balancer in an active-active configuration.
  replicas: {{ default 2 .Values.st2api.replicas }}
  template:
    metadata:
      labels:
        app: st2api
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
    spec:
      imagePullSecrets:
      {{- if .Values.enterprise.enabled }}
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      {{- if .Values.st2.packs.image.pullSecret }}
      - name: {{ .Values.st2.packs.image.pullSecret }}
      {{- end }}
      {{- if .Values.st2.packs.image.repository }}
      initContainers:
      # Merge packs and virtualenvs from st2api with those from the st2.packs image
      # Custom packs
      - name: st2-custom-packs
        image: "{{ .Values.st2.packs.image.repository }}/{{ .Values.st2.packs.image.name }}:{{ .Values.st2.packs.image.tag }}"
        imagePullPolicy: {{ .Values.st2.packs.image.pullPolicy | quote }}
        volumeMounts:
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs-shared
        - name: st2-virtualenvs-vol
          mountPath: /opt/stackstorm/virtualenvs-shared
        command:
          - 'sh'
          - '-ec'
          - |
            /bin/cp -aR /opt/stackstorm/packs/. /opt/stackstorm/packs-shared &&
            /bin/cp -aR /opt/stackstorm/virtualenvs/. /opt/stackstorm/virtualenvs-shared
      # System packs
      - name: st2-system-packs
        image: "{{ template "imageRepository" . }}/st2actionrunner{{ template "enterpriseSuffix" . }}:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        volumeMounts:
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs-shared
        - name: st2-virtualenvs-vol
          mountPath: /opt/stackstorm/virtualenvs-shared
        command:
          - 'sh'
          - '-ec'
          - |
            /bin/cp -aR /opt/stackstorm/packs/. /opt/stackstorm/packs-shared &&
            /bin/cp -aR /opt/stackstorm/virtualenvs/. /opt/stackstorm/virtualenvs-shared
      {{- end }}
      containers:
      - name: st2api{{ template "enterpriseSuffix" . }}
        image: "{{ template "imageRepository" . }}/st2api{{ template "enterpriseSuffix" . }}:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - containerPort: 9101
        # TODO: Add liveness/readiness probes (#3)
        #livenessProbe:
        #readinessProbe:
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        {{- if .Values.st2.packs.image.repository }}
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs
          readOnly: true
        - name: st2-virtualenvs-vol
          mountPath: /opt/stackstorm/virtualenvs
          readOnly: true
        {{- end }}
        resources:
{{ toYaml .Values.st2api.resources | indent 10 }}
    {{- if .Values.st2api.serviceAccount.attach }}
      serviceAccountName: {{ template "stackstorm-ha.serviceAccountName" . }}
    {{- end }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
        {{- if .Values.st2.packs.image.repository }}
        - name: st2-packs-vol
          emptyDir: {}
        - name: st2-virtualenvs-vol
          emptyDir: {}
        {{- end }}
    {{- with .Values.st2api.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2api.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2api.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2stream{{ template "enterpriseSuffix" . }}
  labels:
    app: st2stream
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2stream
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2stream
  # Multiple st2stream process can be behind a load balancer in an active-active configuration.
  replicas: {{ default 2 .Values.st2stream.replicas }}
  template:
    metadata:
      labels:
        app: st2stream
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      containers:
      - name: st2stream{{ template "enterpriseSuffix" . }}
        image: "{{ template "imageRepository" . }}/st2stream{{ template "enterpriseSuffix" . }}:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - containerPort: 9102
        # TODO: Add liveness/readiness probes (#3)
        #livenessProbe:
        #readinessProbe:
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        resources:
{{ toYaml .Values.st2stream.resources | indent 10 }}
    {{- if .Values.st2stream.serviceAccount.attach }}
      serviceAccountName: {{ template "stackstorm-ha.serviceAccountName" . }}
    {{- end }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
    {{- with .Values.st2stream.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2stream.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2stream.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2web{{ template "enterpriseSuffix" . }}
  labels:
    app: st2web
    tier: frontend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2web
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  replicas: {{ default 2 .Values.st2web.replicas }}
  template:
    metadata:
      labels:
        app: st2web
        tier: frontend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      containers:
      - name: st2web{{ template "enterpriseSuffix" . }}
        image: "{{ template "imageRepository" . }}/st2web{{ template "enterpriseSuffix" . }}:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - containerPort: 80
        # Probe to check if app is running. Failure will lead to a pod restart.
        livenessProbe:
          httpGet:
            scheme: HTTP
            path: /
            port: 80
          initialDelaySeconds: 1
        # Probe to check if app is ready to serve traffic. Failure will lead to temp stop serving traffic.
        # TODO: Failing to add readinessProbe, since st2 requires authorization (401) and we don't have `/healthz` endpoints yet (https://github.com/StackStorm/st2/issues/4020)
#        readinessProbe:
#          httpGet:
#            # Probes can't check several endpoints, - this should be implemented on app side (@see https://www.ianlewis.org/en/using-kubernetes-health-checks)
#            # Also multiple liveness checks are not available (@see https://github.com/kubernetes/kubernetes/issues/37218)
#            # So checking ST2_API only
#            scheme: HTTPS
#            path: /api/
#            port: 443
#          initialDelaySeconds: 3
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
            optional: true
        volumeMounts: []
        resources:
{{ toYaml .Values.st2web.resources | indent 10 }}
    {{- if .Values.st2web.serviceAccount.attach }}
      serviceAccountName: {{ template "stackstorm-ha.serviceAccountName" . }}
    {{- end }}
      volumes: []
    {{- with .Values.st2web.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2web.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2web.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2rulesengine{{ template "enterpriseSuffix" . }}
  labels:
    app: st2rulesengine
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2rulesengine
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2rulesengine
  # Multiple st2rulesengine processes can run in active-active with only connections to MongoDB and RabbitMQ. All these will share the TriggerInstance load and naturally pick up more work if one or more of the processes becomes unavailable.
  replicas: {{ default 2 .Values.st2rulesengine.replicas }}
  template:
    metadata:
      labels:
        app: st2rulesengine
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      containers:
      - name: st2rulesengine{{ template "enterpriseSuffix" . }}
        image: "{{ template "imageRepository" . }}/st2rulesengine{{ template "enterpriseSuffix" . }}:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        # TODO: Add liveness/readiness probes (#3)
        #livenessProbe:
        #readinessProbe:
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        resources:
{{ toYaml .Values.st2rulesengine.resources | indent 10 }}
    {{- if .Values.st2rulesengine.serviceAccount.attach }}
      serviceAccountName: {{ template "stackstorm-ha.serviceAccountName" . }}
    {{- end }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
    {{- with .Values.st2rulesengine.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2rulesengine.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2rulesengine.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2timersengine{{ template "enterpriseSuffix" . }}
  labels:
    app: st2timersengine
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2timersengine
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2timersengine
  # Only single replica is created as timersengine can't work in active-active mode at the moment and it relies on
  # K8s failover/reschedule capabilities to address cases when the process fails.
  replicas: 1
  template:
    metadata:
      labels:
        app: st2timersengine
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      containers:
      - name: st2timersengine{{ template "enterpriseSuffix" . }}
        image: "{{ template "imageRepository" . }}/st2timersengine{{ template "enterpriseSuffix" . }}:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        # TODO: Add liveness/readiness probes (#3)
        #livenessProbe:
        #readinessProbe:
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        resources:
{{ toYaml .Values.st2timersengine.resources | indent 10 }}
    {{- if .Values.st2timersengine.serviceAccount.attach }}
      serviceAccountName: {{ template "stackstorm-ha.serviceAccountName" . }}
    {{- end }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
    {{- with .Values.st2timersengine.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2timersengine.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2timersengine.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2workflowengine{{ template "enterpriseSuffix" . }}
  labels:
    app: st2workflowengine
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2workflowengine
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2workflowengine
  # Multiple st2workflowengine processes can run in active-active mode and will share the load and pick up more work if one or more of the processes become available.
  replicas: {{ default 2 .Values.st2workflowengine.replicas }}
  template:
    metadata:
      labels:
        app: st2workflowengine
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      containers:
      - name: st2workflowengine{{ template "enterpriseSuffix" . }}
        image: "{{ template "imageRepository" . }}/st2workflowengine{{ template "enterpriseSuffix" . }}:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        # TODO: Add liveness/readiness probes (#3)
        #livenessProbe:
        #readinessProbe:
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        resources:
{{ toYaml .Values.st2workflowengine.resources | indent 10 }}
    {{- if .Values.st2workflowengine.serviceAccount.attach }}
      serviceAccountName: {{ template "stackstorm-ha.serviceAccountName" . }}
    {{- end }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
    {{- with .Values.st2workflowengine.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2workflowengine.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2workflowengine.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2scheduler{{ template "enterpriseSuffix" . }}
  labels:
    app: st2scheduler
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2scheduler
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2scheduler
  replicas: {{ default 2 .Values.st2scheduler.replicas }}
  template:
    metadata:
      labels:
        app: st2scheduler
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      containers:
      - name: st2scheduler{{ template "enterpriseSuffix" . }}
        image: "{{ template "imageRepository" . }}/st2scheduler{{ template "enterpriseSuffix" . }}:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        # TODO: Add liveness/readiness probes (#3)
        #livenessProbe:
        #readinessProbe:
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        resources:
{{ toYaml .Values.st2scheduler.resources | indent 10 }}
    {{- if .Values.st2scheduler.serviceAccount.attach }}
      serviceAccountName: {{ template "stackstorm-ha.serviceAccountName" . }}
    {{- end }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
    {{- with .Values.st2scheduler.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2scheduler.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2scheduler.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2notifier{{ template "enterpriseSuffix" . }}
  labels:
    app: st2notifier
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2notifier
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2notifier
  # st2notifier runs in active-active mode and requires for that coordination backend like Redis or Zookeeper
  replicas: {{ default 2 .Values.st2notifier.replicas }}
  template:
    metadata:
      labels:
        app: st2notifier
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      containers:
      - name: st2notifier{{ template "enterpriseSuffix" . }}
        image: "{{ template "imageRepository" . }}/st2notifier{{ template "enterpriseSuffix" . }}:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        # TODO: Add liveness/readiness probes (#3)
        #livenessProbe:
        #readinessProbe:
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        resources:
{{ toYaml .Values.st2notifier.resources | indent 10 }}
    {{- if .Values.st2notifier.serviceAccount.attach }}
      serviceAccountName: {{ template "stackstorm-ha.serviceAccountName" . }}
    {{- end }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
    {{- with .Values.st2notifier.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2notifier.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2notifier.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

{{- range .Values.st2.packs.sensors }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ $.Release.Name }}-st2sensorcontainer{{ template "hyphenPrefix" .name }}{{ template "enterpriseSuffix" $ }}
  labels:
    app: st2sensorcontainer{{ template "hyphenPrefix" .name }}
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" $ }}
    chart: {{ $.Chart.Name }}-{{ $.Chart.Version }}
    release: {{ $.Release.Name }}
    heritage: {{ $.Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2sensorcontainer{{ template "hyphenPrefix" .name }}
      support: {{ template "supportMethod" $ }}
      release: {{ $.Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2sensorcontainer
  # It is possible to run st2sensorcontainer in HA mode by running one process on each compute instance. Each sensor node needs to be
  # provided with proper partition information to share work with other sensor nodes so that the same sensor does not run on different nodes.
  # See Partitioning Sensors for information on how to partition sensors.
  replicas: 1
  template:
    metadata:
      labels:
        app: st2sensorcontainer{{ template "hyphenPrefix" .name }}
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" $ }}
        chart: {{ $.Chart.Name }}-{{ $.Chart.Version }}
        release: {{ $.Release.Name }}
        heritage: {{ $.Release.Service }}
    {{- with .annotations }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") $ | sha256sum }}
        checksum/packs: {{ include (print $.Template.BasePath "/configmaps_packs.yaml") $ | sha256sum }}
{{ toYaml . | indent 8 }}
    {{- end }}
    spec:
      imagePullSecrets:
      {{- if $.Values.enterprise.enabled }}
      - name: {{ $.Release.Name }}-st2-license
      {{- end }}
      {{- if $.Values.st2.packs.image.pullSecret }}
      - name: {{ $.Values.st2.packs.image.pullSecret }}
      {{- end }}
      {{- if $.Values.st2.packs.image.repository }}
      initContainers:
      # Merge packs and virtualenvs from st2sensorcontainer with those from the st2.packs image
      # Custom packs
      - name: st2-custom-packs
        image: "{{ $.Values.st2.packs.image.repository }}/{{ $.Values.st2.packs.image.name }}:{{ $.Values.st2.packs.image.tag }}"
        imagePullPolicy: {{ $.Values.st2.packs.image.pullPolicy | quote }}
        volumeMounts:
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs-shared
        - name: st2-virtualenvs-vol
          mountPath: /opt/stackstorm/virtualenvs-shared
        command:
          - 'sh'
          - '-ec'
          - |
            /bin/cp -aR /opt/stackstorm/packs/. /opt/stackstorm/packs-shared &&
            /bin/cp -aR /opt/stackstorm/virtualenvs/. /opt/stackstorm/virtualenvs-shared
      # System packs
      - name: st2-system-packs
        image: "{{ template "imageRepository" $ }}/st2actionrunner{{ template "enterpriseSuffix" $ }}:{{ $.Chart.AppVersion }}"
        imagePullPolicy: {{ $.Values.image.pullPolicy }}
        volumeMounts:
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs-shared
        command:
          - 'sh'
          - '-ec'
          - |
            /bin/cp -aR /opt/stackstorm/packs/. /opt/stackstorm/packs-shared &&
            /bin/cp -aR /opt/stackstorm/virtualenvs/. /opt/stackstorm/virtualenvs-shared
      {{- end }}
      containers:
      - name: st2sensorcontainer{{ template "hyphenPrefix" .name }}{{ template "enterpriseSuffix" $ }}
        image: "{{ template "imageRepository" $ }}/st2sensorcontainer{{ template "enterpriseSuffix" $ }}:{{ $.Chart.AppVersion }}"
        imagePullPolicy: {{ $.Values.image.pullPolicy }}
        {{- with .readinessProbe }}
        # Probe to check if app is running. Failure will lead to a pod restart.
        readinessProbe:
{{ toYaml . | indent 10 }}
        {{- end }}
        {{- with .livenessProbe }}
        livenessProbe:
{{ toYaml . | indent 10 }}
        {{- end }}
        {{- if .ref }}
        command:
          - /opt/stackstorm/st2/bin/st2sensorcontainer
          - --config-file=/etc/st2/st2.conf
          - --config-file=/etc/st2/st2.docker.conf
          - --config-file=/etc/st2/st2.user.conf
          - --single-sensor-mode
          - --sensor-ref={{ .ref }}
        {{- end }}
        envFrom:
        - configMapRef:
            name: {{ $.Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        {{- if $.Values.st2.packs.image.repository }}
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs
          readOnly: true
        - name: st2-virtualenvs-vol
          mountPath: /opt/stackstorm/virtualenvs
          readOnly: true
        {{- end }}
        resources:
{{ toYaml .resources | indent 10 }}
    {{- if .serviceAccount.attach }}
      serviceAccountName: {{ template "stackstorm-ha.serviceAccountName" $ }}
    {{- end }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ $.Release.Name }}-st2-config
        {{- if $.Values.st2.packs.image.repository }}
        - name: st2-packs-vol
          emptyDir: {}
        - name: st2-virtualenvs-vol
          emptyDir: {}
        {{- end }}
    {{- with .nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}
{{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2actionrunner{{ template "enterpriseSuffix" . }}
  labels:
    app: st2actionrunner
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2actionrunner
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2actionrunner
  # Multiple st2actionrunner processes can run in active-active with only connections to MongoDB and RabbitMQ. Work gets naturally
  # distributed across runners via RabbitMQ. Adding more st2actionrunner processes increases the ability of StackStorm to execute actions.
  replicas: {{ default 5 .Values.st2actionrunner.replicas }}
  template:
    metadata:
      labels:
        app: st2actionrunner
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      {{- with .Values.st2actionrunner.annotations }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
        checksum/ssh: {{ include (print $.Template.BasePath "/secrets_ssh.yaml") . | sha256sum }}
{{ toYaml . | indent 8 }}
      {{- end }}
    spec:
      {{- if .Values.st2actionrunner.hostAliases }}
      hostAliases:
{{ toYaml .Values.st2actionrunner.hostAliases | indent 8 }}
      {{- end }}
      imagePullSecrets:
      {{- if .Values.enterprise.enabled }}
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      {{- if .Values.st2.packs.image.pullSecret }}
      - name: {{ .Values.st2.packs.image.pullSecret }}
      {{- end }}
      {{- if .Values.st2.packs.image.repository }}
      initContainers:
      # Merge packs and virtualenvs from st2actionrunner with those from the st2.packs image
      # Custom packs
      - name: st2-custom-packs
        image: "{{ .Values.st2.packs.image.repository }}/{{ .Values.st2.packs.image.name }}:{{ .Values.st2.packs.image.tag }}"
        imagePullPolicy: {{ .Values.st2.packs.image.pullPolicy | quote }}
        volumeMounts:
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs-shared
        - name: st2-virtualenvs-vol
          mountPath: /opt/stackstorm/virtualenvs-shared
        command:
          - 'sh'
          - '-ec'
          - |
            /bin/cp -aR /opt/stackstorm/packs/. /opt/stackstorm/packs-shared &&
            /bin/cp -aR /opt/stackstorm/virtualenvs/. /opt/stackstorm/virtualenvs-shared
      # System packs
      - name: st2-system-packs
        image: "{{ template "imageRepository" . }}/st2actionrunner{{ template "enterpriseSuffix" . }}:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        volumeMounts:
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs-shared
        command:
          - 'sh'
          - '-ec'
          - |
            /bin/cp -aR /opt/stackstorm/packs/. /opt/stackstorm/packs-shared &&
            /bin/cp -aR /opt/stackstorm/virtualenvs/. /opt/stackstorm/virtualenvs-shared
      {{- end }}
      containers:
      - name: st2actionrunner{{ template "enterpriseSuffix" . }}
        image: "{{ template "imageRepository" . }}/st2actionrunner{{ template "enterpriseSuffix" . }}:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        # TODO: Add liveness/readiness probes (#3)
        #livenessProbe:
        #readinessProbe:
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        - name: st2-ssh-key-vol
          mountPath: /home/stanley/.ssh/
          readOnly: true
        {{- if .Values.st2.packs.image.repository }}
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs
          readOnly: true
        - name: st2-virtualenvs-vol
          mountPath: /opt/stackstorm/virtualenvs
          readOnly: true
        {{- end }}
        resources:
{{ toYaml .Values.st2actionrunner.resources | indent 10 }}
    {{- if .Values.st2actionrunner.serviceAccount.attach }}
      serviceAccountName: {{ template "stackstorm-ha.serviceAccountName" . }}
    {{- end }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
        - name: st2-ssh-key-vol
          secret:
            secretName: {{ .Release.Name }}-st2-ssh
            items:
            - key: private_key
              path: stanley_rsa
              # 0400 file permission
              mode: 256
        {{- if .Values.st2.packs.image.repository }}
        - name: st2-packs-vol
          emptyDir: {}
        - name: st2-virtualenvs-vol
          emptyDir: {}
        {{- end }}
    {{- with .Values.st2actionrunner.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2actionrunner.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2actionrunner.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2garbagecollector{{ template "enterpriseSuffix" . }}
  labels:
    app: st2garbagecollector
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2garbagecollector
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2garbagecollector
  # Having 1 st2garbagecollector unique replica is enough for periodic task like st2 history garbage collection
  replicas: {{ default 1 .Values.st2garbagecollector.replicas }}
  template:
    metadata:
      labels:
        app: st2garbagecollector
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      containers:
      - name: st2garbagecollector{{ template "enterpriseSuffix" . }}
        image: "{{ template "imageRepository" . }}/st2garbagecollector{{ template "enterpriseSuffix" . }}:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        # TODO: Add liveness/readiness probes (#3)
        #livenessProbe:
        #readinessProbe:
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        resources:
{{ toYaml .Values.st2garbagecollector.resources | indent 10 }}
    {{- if .Values.st2garbagecollector.serviceAccount.attach }}
      serviceAccountName: {{ template "stackstorm-ha.serviceAccountName" . }}
    {{- end }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
    {{- with .Values.st2garbagecollector.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2garbagecollector.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2garbagecollector.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2client{{ template "enterpriseSuffix" . }}
  labels:
    app: st2client
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2client
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  replicas: 1
  template:
    metadata:
      labels:
        app: st2client
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
        {{- if .Values.enterprise.enabled }}
        checksum/rbac: {{ include (print $.Template.BasePath "/configmaps_rbac.yaml") . | sha256sum }}
        {{- end }}
        checksum/packs: {{ include (print $.Template.BasePath "/configmaps_packs.yaml") . | sha256sum }}
        checksum/auth: {{ include (print $.Template.BasePath "/secrets_st2auth.yaml") . | sha256sum }}
        checksum/ssh: {{ include (print $.Template.BasePath "/secrets_ssh.yaml") . | sha256sum }}
    spec:
      imagePullSecrets:
      {{- if .Values.enterprise.enabled }}
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      {{- if .Values.st2.packs.image.pullSecret }}
      - name: {{ .Values.st2.packs.image.pullSecret }}
      {{- end }}
      initContainers:
      {{- if .Values.st2.packs.image.repository }}
      # Merge packs and virtualenvs from st2actionrunner with those from the st2.packs image
      # Custom packs
      - name: st2-custom-packs
        image: "{{ .Values.st2.packs.image.repository }}/{{ .Values.st2.packs.image.name }}:{{ .Values.st2.packs.image.tag }}"
        imagePullPolicy: {{ .Values.st2.packs.image.pullPolicy | quote }}
        volumeMounts:
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs-shared
        - name: st2-virtualenvs-vol
          mountPath: /opt/stackstorm/virtualenvs-shared
        command:
          - 'sh'
          - '-ec'
          - |
            /bin/cp -aR /opt/stackstorm/packs/. /opt/stackstorm/packs-shared &&
            /bin/cp -aR /opt/stackstorm/virtualenvs/. /opt/stackstorm/virtualenvs-shared
      # System packs
      - name: st2-system-packs
        image: "{{ template "imageRepository" . }}/st2actionrunner{{ template "enterpriseSuffix" . }}:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        volumeMounts:
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs-shared
        command:
          - 'sh'
          - '-ec'
          - |
            /bin/cp -aR /opt/stackstorm/packs/. /opt/stackstorm/packs-shared &&
            /bin/cp -aR /opt/stackstorm/virtualenvs/. /opt/stackstorm/virtualenvs-shared
      {{- end }}
      # Sidecar container for generating st2client config with st2 username & password pair and sharing produced file with the main container
      - name: generate-st2client-config
        image: "{{ template "imageRepository" . }}/st2actionrunner{{ template "enterpriseSuffix" . }}:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        env:
        - name: ST2_AUTH_USERNAME
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-st2-auth
              key: username
        - name: ST2_AUTH_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-st2-auth
              key: password
        volumeMounts:
        - name: st2client-config-vol
          mountPath: /root/.st2/
        # `st2 login` doesn't exit on failure correctly, use old methods instead. See bug: https://github.com/StackStorm/st2/issues/4338
        command:
          - 'sh'
          - '-ec'
          - |
            cat <<EOT > /root/.st2/config
            [credentials]
            username = ${ST2_AUTH_USERNAME}
            password = ${ST2_AUTH_PASSWORD}
            EOT
      containers:
      - name: st2client{{ template "enterpriseSuffix" . }}
        image: "{{ template "imageRepository" . }}/st2actionrunner{{ template "enterpriseSuffix" . }}:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        env:
        - name: ST2CLIENT
          value: "1"
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        {{- if .Values.enterprise.enabled }}
        - name: st2-rbac-roles-vol
          mountPath: /opt/stackstorm/rbac/roles/
        - name: st2-rbac-assignments-vol
          mountPath: /opt/stackstorm/rbac/assignments/
        - name: st2-rbac-mappings-vol
          mountPath: /opt/stackstorm/rbac/mappings/
        {{- end }}
        - name: st2-pack-configs-vol
          mountPath: /opt/stackstorm/configs/
        - name: st2client-config-vol
          mountPath: /root/.st2/
        - name: st2-ssh-key-vol
          mountPath: /home/stanley/.ssh/
          readOnly: true
        {{- if .Values.st2.packs.image.repository }}
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs
          readOnly: true
        - name: st2-virtualenvs-vol
          mountPath: /opt/stackstorm/virtualenvs
          readOnly: true
        {{- end }}
        command:
          - 'bash'
          - '-ec'
          - 'while true; do sleep 999; done'
        resources:
          requests:
            memory: "5Mi"
            cpu: "5m"
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
        {{- if .Values.enterprise.enabled }}
        - name: st2-rbac-roles-vol
          configMap:
            name: {{ .Release.Name }}-st2-rbac-roles
        - name: st2-rbac-assignments-vol
          configMap:
            name: {{ .Release.Name }}-st2-rbac-assignments
        - name: st2-rbac-mappings-vol
          configMap:
            name: {{ .Release.Name }}-st2-rbac-mappings
        {{- end }}
        - name: st2-pack-configs-vol
          configMap:
            name: {{ .Release.Name }}-st2-pack-configs
        - name: st2client-config-vol
          emptyDir:
            medium: Memory
        - name: st2-ssh-key-vol
          secret:
            secretName: {{ .Release.Name }}-st2-ssh
            items:
            - key: private_key
              path: stanley_rsa
              # 0400 file permission
              mode: 256
        {{- if .Values.st2.packs.image.repository }}
        - name: st2-packs-vol
          emptyDir: {}
        - name: st2-virtualenvs-vol
          emptyDir: {}
        {{- end }}

{{ if .Values.st2chatops.enabled -}}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2chatops{{ template "enterpriseSuffix" . }}
  labels:
    app: st2chatops
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2chatops
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # As hubot can't be HA scaled properly, we deploy only single replica of st2chatops
  replicas: 1
  template:
    metadata:
      labels:
        app: st2chatops
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/chatops: {{ include (print $.Template.BasePath "/secrets_st2chatops.yaml") . | sha256sum }}
    spec:
      containers:
      - name: st2chatops{{ template "enterpriseSuffix" . }}
        image: "{{ .Values.st2chatops.image.repository | default "stackstorm" }}/{{ .Values.st2chatops.image.name | default "st2chatops" }}:{{ tpl (.Values.st2chatops.image.tag | default .Chart.AppVersion) . }}"
        imagePullPolicy: {{ .Values.st2chatops.image.pullPolicy | default .Values.image.pullPolicy }}
        env:
        - name: ST2_AUTH_USERNAME
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-st2-auth
              key: username
        - name: ST2_AUTH_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-st2-auth
              key: password
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        - secretRef:
            name: {{ .Release.Name }}-st2chatops
        ports:
        - containerPort: 8081
        # TODO: Add to st2chatops Docker image https://github.com/joelwallis/hubot-health for a little bit more reliable HTTP health endpoint check
        readinessProbe:
          tcpSocket:
            port: 8081
          initialDelaySeconds: 3
          periodSeconds: 10
        livenessProbe:
          tcpSocket:
            port: 8081
          initialDelaySeconds: 10
          periodSeconds: 30
        resources:
{{ toYaml .Values.st2chatops.resources | indent 10 }}
    {{- if .Values.st2chatops.serviceAccount.attach }}
        serviceAccountName: {{ template "stackstorm-ha.serviceAccountName" . }}
    {{- end }}
    {{- with .Values.st2chatops.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2chatops.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2chatops.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}
{{- end }}
